<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه ثبت اضافه کاری</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color for Browser UI -->
    <meta name="theme-color" content="#4a90e2">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4a90e2/ffffff?text=App">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="jalali-moment.browser.js"></script>
    <script src="xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-left: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .modal-backdrop { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 flex flex-col items-center">
            <!-- Iran Alumina Company Logo -->
            <img src="Logo.png" alt="لوگوی شرکت آلومینای ایران" class="h-[42px] w-[42px] mb-4 object-contain" onerror="this.src='https://placehold.co/42x42/cccccc/ffffff?text=IAC'">
            <h1 class="text-2xl font-bold text-gray-800">شرکت آلومینای ایران</h1>
            <p class="text-lg text-gray-600">جاجرم</p>
            <hr class="w-48 my-4 border-gray-300">
            <h2 class="text-xl font-bold text-gray-700">سامانه ثبت و مدیریت اضافه کاری</h2>
        </header>

        <main>
            <!-- Form Section -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <form id="overtime-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                        <label for="date-input" class="block mb-2 font-medium text-gray-700">تاریخ</label>
                        <input type="text" id="date-input" placeholder="مثال: 1403/06/22" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <button type="button" id="today-btn" class="text-sm text-blue-600 hover:text-blue-800 mt-2">برو به تاریخ امروز</button>
                    </div>

                    <div>
                        <label for="shift-type" class="block mb-2 font-medium text-gray-700">نوع شیفت / روز</label>
                        <select id="shift-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition form-select">
                            <option value="morning">شیفت صبح</option>
                            <option value="evening">شیفت عصر</option>
                            <option value="night">شیفت شب</option>
                            <option value="rest">استراحت</option>
                            <option value="holiday">روز تعطیل</option>
                        </select>
                    </div>

                    <div>
                        <label for="start-time" class="block mb-2 font-medium text-gray-700">ساعت شروع اضافه کاری</label>
                        <select id="start-time" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition form-select">
                            <!-- Options will be generated by JS -->
                        </select>
                    </div>

                    <div>
                        <label for="end-time" class="block mb-2 font-medium text-gray-700">ساعت پایان اضافه کاری</label>
                        <select id="end-time" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition form-select">
                            <!-- Options will be generated by JS -->
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label for="successor-input" class="block mb-2 font-medium text-gray-700">جانشین (اختیاری)</label>
                        <input type="text" id="successor-input" placeholder="نام جانشین (مثال: جواد ابراهیمی)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>

                    <div class="md:col-span-2">
                        <label for="description" class="block mb-2 font-medium text-gray-700">توضیحات (اختیاری)</label>
                        <textarea id="description" rows="3" placeholder="توضیحات مربوط به اضافه کاری..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                    </div>

                    <div class="md:col-span-2 text-left">
                        <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition w-full md:w-auto">
                            ثبت / ویرایش اضافه کاری
                        </button>
                    </div>
                </form>
            </div>

            <!-- Summary and Records Section -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 md:mb-0">سوابق ثبت شده</h2>
                    <div id="total-hours-display" class="text-lg font-bold bg-blue-100 text-blue-800 px-4 py-2 rounded-lg">
                        مجموع اضافه کاری: 0 ساعت
                    </div>
                </div>

                 <!-- Excel Buttons -->
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <button id="export-btn" class="flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition">خروجی اکسل</button>
                    <button id="import-btn" class="flex-1 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition">ورود از اکسل</button>
                    <input type="file" id="import-file" class="hidden" accept=".xlsx, .xls, .csv">
                </div>

                <div id="alert-message" class="hidden p-4 mb-4 text-sm text-yellow-800 rounded-lg bg-yellow-100" role="alert">
                    <span class="font-medium">توجه!</span> مجموع ساعات اضافه کاری شما از ۱۲۰ ساعت عبور کرده است.
                </div>
                
                <div id="error-message" class="hidden p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-100" role="alert"></div>

                <div class="overflow-x-auto">
                    <table class="w-full text-center">
                        <thead class="bg-gray-50 border-b-2 border-gray-200">
                            <tr>
                                <th class="p-3 text-sm font-semibold tracking-wide">تاریخ</th>
                                <th class="p-3 text-sm font-semibold tracking-wide">نوع شیفت</th>
                                <th class="p-3 text-sm font-semibold tracking-wide">جانشین</th>
                                <th class="p-3 text-sm font-semibold tracking-wide">شروع</th>
                                <th class="p-3 text-sm font-semibold tracking-wide">پایان</th>
                                <th class="p-3 text-sm font-semibold tracking-wide">مدت</th>
                                <th class="p-3 text-sm font-semibold tracking-wide hidden md:table-cell">توضیحات</th>
                                <th class="p-3 text-sm font-semibold tracking-wide">عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="overtime-records" class="divide-y divide-gray-100"></tbody>
                    </table>
                     <p id="no-records" class="text-center text-gray-500 py-8">هنوز هیچ سابقه‌ای ثبت نشده است.</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>طراحی و توسعه جواد ابراهیمی توسط هوش مصنوعی Gemini</p>
            <p class="mt-1">نسخه 1.8.0</p>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4" id="modal-title">تایید عملیات</h3>
            <p class="text-gray-600 mb-6" id="modal-body">آیا از انجام این کار مطمئن هستید؟</p>
            <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <button id="modal-cancel-btn" class="w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">انصراف</button>
                <button id="modal-confirm-btn" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">تایید و حذف</button>
            </div>
        </div>
    </div>


    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Element Selection ---
            const form = document.getElementById('overtime-form');
            const dateInput = document.getElementById('date-input');
            const todayBtn = document.getElementById('today-btn');
            const startTimeSelect = document.getElementById('start-time');
            const endTimeSelect = document.getElementById('end-time');
            const descriptionInput = document.getElementById('description');
            const shiftTypeSelect = document.getElementById('shift-type');
            const successorInput = document.getElementById('successor-input');
            const recordsBody = document.getElementById('overtime-records');
            const totalHoursDisplay = document.getElementById('total-hours-display');
            const alertMessage = document.getElementById('alert-message');
            const errorMessage = document.getElementById('error-message');
            const noRecordsP = document.getElementById('no-records');
            const confirmModal = document.getElementById('confirm-modal');
            const modalBody = document.getElementById('modal-body');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('import-file');

            // --- State and Config ---
            let overtimeData = JSON.parse(localStorage.getItem('overtimeData')) || [];
            let confirmCallback = null;
            const shiftTypeMap = { morning: 'شیفت صبح', evening: 'شیفت عصر', night: 'شیفت شب', rest: 'استراحت', holiday: 'روز تعطیل' };
            const shiftTypeMapReverse = Object.fromEntries(Object.entries(shiftTypeMap).map(([k, v]) => [v, k]));


            // --- Core Functions ---
            const saveData = () => localStorage.setItem('overtimeData', JSON.stringify(overtimeData));
            const calculateDuration = (start, end) => {
               start = parseInt(start);
               end = parseInt(end);
               return end > start ? end - start : 24 - start + end;
            };

            const renderRecords = () => {
                recordsBody.innerHTML = '';
                noRecordsP.style.display = overtimeData.length === 0 ? 'block' : 'none';
                
                const sortedData = [...overtimeData].sort((a, b) => moment(b.date, 'jYYYY/jMM/jDD').diff(moment(a.date, 'jYYYY/jMM/jDD')));

                sortedData.forEach(record => {
                    const duration = calculateDuration(record.startTime, record.endTime);
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white hover:bg-gray-50 transition';
                    const shiftText = shiftTypeMap[record.shiftType] || '-';
                    tr.innerHTML = `
                        <td class="p-4 text-sm text-gray-700">${record.date}</td>
                        <td class="p-4 text-sm text-gray-700">${shiftText}</td>
                        <td class="p-4 text-sm text-gray-700">${record.successor || '-'}</td>
                        <td class="p-4 text-sm text-gray-700">${record.startTime}:00</td>
                        <td class="p-4 text-sm text-gray-700">${record.endTime}:00</td>
                        <td class="p-4 text-sm font-medium text-gray-900">${duration} ساعت</td>
                        <td class="p-4 text-sm text-gray-600 hidden md:table-cell">${record.description || '-'}</td>
                        <td class="p-4 text-sm">
                            <button data-date="${record.date}" class="delete-btn text-red-500 hover:text-red-700 font-semibold">حذف</button>
                        </td>
                    `;
                    recordsBody.appendChild(tr);
                });
                updateTotalHours();
            };

            const updateTotalHours = () => {
                const totalHours = overtimeData.reduce((total, record) => total + calculateDuration(record.startTime, record.endTime), 0);
                totalHoursDisplay.textContent = `مجموع اضافه کاری: ${totalHours} ساعت`;
                alertMessage.classList.toggle('hidden', totalHours <= 120);
            };
            
            const showError = (message) => {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                setTimeout(() => errorMessage.classList.add('hidden'), 5000);
            };

            const showConfirmModal = (message, onConfirm) => {
                modalBody.textContent = message;
                confirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('opacity-100');
            };

            const hideConfirmModal = () => {
                confirmModal.classList.add('opacity-0');
                setTimeout(() => {
                    confirmModal.classList.add('hidden');
                    confirmCallback = null;
                }, 300);
            };
            
             // --- Excel Functions ---
            const exportToExcel = () => {
                if (overtimeData.length === 0) {
                    showError("هیچ داده‌ای برای خروجی گرفتن وجود ندارد.");
                    return;
                }

                const dataToExport = overtimeData.map(rec => ({
                    'تاریخ': rec.date,
                    'نوع شیفت': shiftTypeMap[rec.shiftType] || '',
                    'جانشین': rec.successor || '',
                    'ساعت شروع': rec.startTime,
                    'ساعت پایان': rec.endTime,
                    'توضیحات': rec.description || ''
                }));

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Overtime Records");
                XLSX.writeFile(workbook, "OvertimeRecords.xlsx");
            };

            const importFromExcel = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const importedJson = XLSX.utils.sheet_to_json(worksheet);

                        if(importedJson.length === 0) {
                            showError("فایل اکسل خالی است یا فرمت آن صحیح نیست.");
                            return;
                        }

                        const currentDataMap = overtimeData.reduce((map, item) => {
                            map[item.date] = item;
                            return map;
                        }, {});

                        let importedCount = 0;
                        importedJson.forEach(row => {
                            const date = String(row['تاریخ'] || '').trim();
                            if(moment(date, 'jYYYY/jMM/jDD', true).isValid()) {
                                const shiftTypePersian = row['نوع شیفت'];
                                currentDataMap[date] = {
                                    date: date,
                                    shiftType: shiftTypeMapReverse[shiftTypePersian] || 'rest',
                                    successor: String(row['جانشین'] || '').trim(),
                                    startTime: String(row['ساعت شروع'] || '1').trim(),
                                    endTime: String(row['ساعت پایان'] || '1').trim(),
                                    description: String(row['توضیحات'] || '').trim(),
                                };
                                importedCount++;
                            }
                        });

                        if(importedCount > 0) {
                           overtimeData = Object.values(currentDataMap);
                           saveData();
                           renderRecords();
                        } else {
                           showError("هیچ رکورد معتبری در فایل اکسل برای ورود یافت نشد. مطمئن شوید ستون 'تاریخ' با فرمت صحیح وجود دارد.");
                        }

                    } catch (err) {
                        showError("خطا در پردازش فایل اکسل. لطفاً از صحت فایل اطمینان حاصل کنید.");
                        console.error(err);
                    } finally {
                        importFile.value = ''; 
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // --- Event Handlers ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const date = dateInput.value.trim();
                const startTime = startTimeSelect.value;
                const startHour = parseInt(startTime);
                const endTime = endTimeSelect.value;
                const description = descriptionInput.value.trim();
                const shiftType = shiftTypeSelect.value;
                const successor = successorInput.value.trim();

                if (!date || !moment(date, 'jYYYY/jMM/jDD', true).isValid()) {
                    return showError('لطفاً تاریخ را با فرمت صحیح (مثال: 1403/06/22) وارد کنید.');
                }
                if (startTime === endTime) {
                    return showError('ساعت شروع و پایان نمی‌تواند یکسان باشد.');
                }

                if ((shiftType === 'morning' && startHour < 16) ||
                    (shiftType === 'evening' && startHour >= 15 && startHour <= 23) ||
                    (shiftType === 'night' && (startHour >= 23 || startHour <= 7))) {
                    return showError('ساعت اضافه کاری با نوع شیفت انتخاب شده مغایرت دارد.');
                }
                
                const existingRecordIndex = overtimeData.findIndex(record => record.date === date);
                const newRecord = { date, startTime, endTime, description, shiftType, successor };

                if (existingRecordIndex > -1) overtimeData[existingRecordIndex] = newRecord;
                else overtimeData.push(newRecord);

                saveData();
                renderRecords();
                form.reset();
                dateInput.value = moment().locale('fa').format('YYYY/MM/DD');
            });
            
            recordsBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const dateToDelete = e.target.dataset.date;
                    showConfirmModal(`آیا از حذف اضافه کاری تاریخ ${dateToDelete} مطمئن هستید؟`, () => {
                        overtimeData = overtimeData.filter(record => record.date !== dateToDelete);
                        saveData();
                        renderRecords();
                        hideConfirmModal();
                    });
                }
            });

            // --- Setup and Initial Load ---
            const init = () => {
                for (let i = 1; i <= 24; i++) {
                    startTimeSelect.add(new Option(`${i}:00`, i));
                    endTimeSelect.add(new Option(`${i}:00`, i));
                }
                dateInput.value = moment().locale('fa').format('YYYY/MM/DD');
                renderRecords();
                todayBtn.addEventListener('click', () => dateInput.value = moment().locale('fa').format('YYYY/MM/DD'));
                modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); });
                modalCancelBtn.addEventListener('click', hideConfirmModal);
                confirmModal.addEventListener('click', (e) => { if(e.target === confirmModal) hideConfirmModal(); });
                exportBtn.addEventListener('click', exportToExcel);
                importBtn.addEventListener('click', () => importFile.click());
                importFile.addEventListener('change', importFromExcel);
            };

            init();
        });
    </script>

</body>
</html>

